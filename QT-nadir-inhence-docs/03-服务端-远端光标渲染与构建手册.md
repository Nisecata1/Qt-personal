# QtScrcpy 服务端手册：远端光标渲染与构建

## 1. 适用范围

本手册只覆盖“远端光标可视反馈”模块：控制协议扩展、Java server 图层渲染、构建与替换流程。

## 2. 目标与约束

1. 输入注入仍保持 `TOUCHSCREEN`，不切换到 `MOUSE`。
2. 视觉层与控制层分离：触控照常注入，光标单独渲染。
3. 不影响主触控链路；渲染失败可降级为“无光标显示”。

## 3. 协议设计

### 3.1 `TYPE_INJECT_CURSOR = 0x80`

- 载荷（大端）：`x:int32, y:int32, w:int32, h:int32`
- 语义：
  - `x >= 0`：显示并移动光标
  - `x < 0`：隐藏光标图层（建议包：`-1,-1,0,0`）

### 3.2 `TYPE_SET_CURSOR_CONFIG = 0x81`（可选）

- 载荷（大端）：`cursorSizePx:int32`
- 语义：调整远端光标大小（建议范围 `8..128`）

## 4. 客户端联动建议（Qt/C++）

1. Normal 模式：在鼠标移动事件中发送 `0x80` 绝对坐标。
2. Game 相对模式：切入时发送一次 hide 包。
3. 尺寸改动：在配置更新后发送 `0x81`。
4. 节流：坐标未变化不发送，减少无效流量。

## 5. Java server 实现建议

1. `ControlMessage` 增加 `TYPE_INJECT_CURSOR` / `TYPE_SET_CURSOR_CONFIG`。
2. `ControlMessageReader` 增加对应字段读取。
3. `Controller` 分发：
   - hide 分支
   - show/move 分支
   - set size 分支
4. 新增 `CursorOverlay`：
   - 使用 `SurfaceControl` 或 `SurfaceControl.Transaction` 反射创建顶层透明图层
   - 初始化时绘制光标 bitmap/图形
   - 运行中通过 `setPosition()` 高频平移

## 6. 构建与替换

### 6.1 推荐基线

- 上游基线提交：`10a0974f43cce259ba6c36346e3d962bf06e5259`

### 6.2 构建命令

```bash
./gradlew -p server assembleRelease
```

### 6.3 补丁应用

```bash
git apply --check scrcpy_cursor_overlay.patch
git apply scrcpy_cursor_overlay.patch
```

### 6.4 替换产物

1. 将 `server-release-unsigned.apk` 重命名为 `scrcpy-server`。
2. 覆盖到：`QtScrcpy/QtScrcpyCore/src/third_party/scrcpy-server`。
3. 重新编译 QtScrcpy 客户端。

## 7. 配置文件说明（配置项）

### `config.ini [common]`

```ini
RemoteCursorEnabled=true
CursorSizePx=64
```

- `RemoteCursorEnabled`：是否启用远端光标
- `CursorSizePx`：远端光标尺寸，建议 `8..128`

## 8. 验收清单

1. Normal 模式移动鼠标时，手机画面可见光标跟随。
2. 切入 Game 相对模式时，光标立即隐藏。
3. 点击行为仍走触控路径，功能正常。
4. 修改 `CursorSizePx` 后尺寸生效。
5. 反射失败时主触控不中断，仅降级为无光标显示。

## 9. 排障

1. 光标不显示：确认使用定制 server，而非官方原版。
2. 尺寸无效：确认 `0x81` 已在 reader/controller 端实现。
3. 偏移异常：检查坐标映射链路（client 坐标到 video 映射）。

## 10. 关联文档

1. 视角模式稳定：`01-输入链路-视角模式稳定性手册.md`
2. 方向盘回正：`02-输入链路-方向盘回正配置手册.md`
3. 全局速查：`04-全局配置速查与验收清单.md`
