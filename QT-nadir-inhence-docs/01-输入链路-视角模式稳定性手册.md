# QtScrcpy 输入链路手册：视角模式稳定性

## 1. 适用范围
本手册只覆盖“相对视角移动（Mouse Move / Look）”链路稳定性问题，不包含方向盘回正与 server 光标渲染。

## 2. 已解决问题

1. 退出视角模式后触点未及时释放，导致重进状态脏。
2. 重进后首帧大角度跳变（首跳）。
3. 小眼模式异步回调存在状态竞态风险。
4. 首帧拦截时 DOWN/MOVE 时序不稳定。

## 3. 核心思路

1. 统一会话重置入口：`resetMouseMoveSession(bool releaseTouch)`。
2. 首帧只建基准，不发送 `MOVE`，确保先有 `DOWN`。
3. 平滑状态改为实例成员，避免跨会话残留污染。
4. 小眼逻辑改为对象内定时器和槽函数，统一 `stop/start` 与状态守卫。

## 4. 关键改造点（代码层）

1. 统一清理：空闲计时器、异步 timer、平滑缓存、触控状态。
2. 切模式时：
   - 切出视角模式：立即释放触点（`UP`）。
   - 切回视角模式：标记重建基准，下一帧先对齐再发增量。
3. 鼠标重定位后强制 `needRebase=true`，避免异常 delta。
4. 发送 `UP` 前增加 touch id 有效性检查。

## 5. 配置项（userdata.ini）

### [common] `MouseSmoothFrames`
- 含义：视角增量平滑窗口（SMA）。
- 范围：`1 ~ 20`
- 默认：`4`

建议值：
- 低延迟：`2~3`
- 平衡：`4~5`
- 稳定抗抖：`6~8`

## 6. 验收清单

1. 退出视角模式后应立即断触，不依赖空闲超时。
2. 重进视角模式后第一下移动不应出现首跳。
3. 连续执行“退出/重进”10次，无残留触控。
4. 小眼模式与切模式交错测试，无异步误触发。
5. 回归普通点击、拖拽、边界环绕行为。

## 7. 关联文档

1. 方向盘回正：`02-输入链路-方向盘回正配置手册.md`
2. 远端光标与 server：`03-服务端-远端光标渲染与构建手册.md`
3. 全局速查：`04-全局配置速查与验收清单.md`
