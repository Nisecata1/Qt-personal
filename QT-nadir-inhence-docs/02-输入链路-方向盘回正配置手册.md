# QtScrcpy 输入链路手册：方向盘回正（SteerWheel）

## 1. 适用范围
本手册只覆盖 `inputconvertgame.cpp/.h` 中方向盘（WASD）输入在组合键切换时的“向量插值回正”机制。

## 2. 已解决问题

1. `W+A -> W` 等退化场景中，旧轨迹带噪声累积，容易“回不正”。
2. 直接瞬移回正会引发突兀手感与潜在输入风控风险。
3. 噪声与闭合精度难以兼顾。

## 3. 核心思路

1. 每次方向键状态变化都重算目标方向（8方向：上下左右 + 四个对角）。
2. 从 `currentPos` 到 `targetPos` 生成平滑 Lerp 队列，而非瞬移。
3. 使用“中段噪声 + 末段收敛 + 终点微噪”混合模型。
4. 全松键行为保持原策略：立即 `UP + detach`。

## 4. 关键实现点（代码层）

1. 新增配置热加载：`reloadSteerWheelRecoveryConfigIfNeeded()`。
2. 新增恢复队列构建：`getSteerWheelRecoveryQueue(...)`。
3. 定时器发送路径增加防御：
   - touch id 有效性检查
   - 空队列保护
4. 坐标统一钳制到 `[0,1]`，避免越界。

## 5. 配置手册（userdata.ini）

> 分组：`[common]`

### `SteerWheelRecoverySpeed`
- 默认：`0.45`
- 范围：`0.1 ~ 1.0`
- 含义：回正速度，越大越快。

### `SteerWheelRecoveryNoise`
- 默认：`0.0020`
- 范围：`0.0 ~ 0.01`
- 含义：中段轨迹每步扰动强度。

### `SteerWheelRecoveryFinalNoise`
- 默认：`0.0004`
- 范围：`0.0 ~ 0.005`
- 含义：终点微扰动强度。

## 6. 推荐模板

### 平衡
```ini
[common]
SteerWheelRecoverySpeed=0.45
SteerWheelRecoveryNoise=0.0020
SteerWheelRecoveryFinalNoise=0.0004
```

### 稳准
```ini
[common]
SteerWheelRecoverySpeed=0.35
SteerWheelRecoveryNoise=0.0012
SteerWheelRecoveryFinalNoise=0.0001
```

### 激进
```ini
[common]
SteerWheelRecoverySpeed=0.70
SteerWheelRecoveryNoise=0.0025
SteerWheelRecoveryFinalNoise=0.0006
```

## 7. 调优建议

1. 想更快：先升 `SteerWheelRecoverySpeed`（每次 +0.05）。
2. 想更稳：先降 `SteerWheelRecoveryNoise`。
3. 想更准：降 `SteerWheelRecoveryFinalNoise`，必要时设为 `0`。

## 8. 验收清单

1. `W+A` 松 `A` 后应平滑回到上方向，不持续偏左。
2. `W+D`、`S+A`、`S+D` 到单轴时应同样闭合。
3. `Speed=0.1` 与 `Speed=1.0` 均无突跳卡顿。
4. 高频按放不应残留触点。
5. 修改参数后下一次方向键事件应生效（热加载）。

## 9. 关联文档

1. 视角模式稳定：`01-输入链路-视角模式稳定性手册.md`
2. 远端光标与 server：`03-服务端-远端光标渲染与构建手册.md`
3. 全局速查：`04-全局配置速查与验收清单.md`
